{% extends "base.html" %}

{% block content %}
<div class="quiz-container">
    <div class="quiz-header">
        <span class="progress">Question {{ index }} of {{ total }}</span>
        <span class="stats">Avg Time: {{ "%.1f"|format(avg_time) }}s</span>
        <span class="timer" id="timer">00:00</span>
    </div>

    <!-- Flash Messages Popup -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flash-popup" class="flash-popup">
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">
            <span>{{ message }}</span>
            <button onclick="this.closest('.flash-popup').style.display='none'" class="close-btn">OK</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="context-box">
        <h3>Context</h3>
        <!-- Render Markdown Context -->
        <div class="markdown-content">
            {{ context_html | safe }}
        </div>

        <!-- Canvas for Chart.js if chart_data exists -->
        {% if question.chart_data %}
        <div class="chart-container" style="position: relative; height:400px; width:100%; margin-top: 20px;">
            <canvas id="dataChart"></canvas>
        </div>
        {% endif %}
    </div>

    <div class="question-box">
        <h3>Question</h3>
        <p>{{ question.question }}</p>

        <form method="POST">
            <div class="select-wrapper">
                <select name="answer" required>
                    <option value="" disabled selected>Select an answer...</option>
                    {% for opt in options %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                </select>
            </div>
    </div>
    <div class="button-group">
        <button type="submit" class="btn-submit">Submit Answer</button>
        <a href="{{ url_for('finish_early') }}" class="btn-secondary"
            onclick="return confirm('Are you sure you want to finish the quiz early?');">Finish Quiz</a>
    </div>
    </form>
</div>
</div>

<style>
    .button-group {
        display: flex;
        gap: 1rem;
    }

    .btn-secondary {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background-color: #9CA3AF;
        color: white;
        text-decoration: none;
        border-radius: 0.375rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        text-align: center;
        flex: 1;
    }

    .btn-secondary:hover {
        background-color: #6B7280;
    }

    .btn-submit {
        flex: 2;
    }
</style>

<script>
    // Countdown Timer
    let timeLimit = {{ time_limit }};
    let timeLeft = timeLimit;
    const timerElement = document.getElementById('timer');

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;

        timerElement.textContent =
            (minutes < 10 ? '0' + minutes : minutes) + ':' +
            (secs < 10 ? '0' + secs : secs);

        // Visual warning
        if (timeLeft <= 15) {
            timerElement.style.color = '#EF4444'; // Red
            timerElement.style.fontWeight = 'bold';
        } else {
            timerElement.style.color = ''; // Reset
        }

        if (timeLeft > 0) {
            timeLeft--;
        } else {
            // Optional: Auto-submit or just stay red?
            // User request implies "limit", usually means forced move. 
            // We can just label it "Time's Up!" for now or force submit.
            // Let's force submit for authentic "test" feel if feasible, 
            // but for "practice" maybe just annoyance?
            // Let's stick to visual for now to avoid frustration.
            timerElement.textContent = "00:00";
        }
    }

    // Initial call
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);

    // Chart Parsing Logic
    document.addEventListener('DOMContentLoaded', function () {
        const chartData = {{ question.chart_data | tojson | safe
    }};

    if (chartData) {
        const ctx = document.getElementById('dataChart').getContext('2d');

        // Assign colors
        const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

        chartData.data.datasets.forEach((ds, index) => {
            const color = colors[index % colors.length];
            ds.backgroundColor = chartData.type === 'pie' ? colors : color;
            ds.borderColor = chartData.type === 'pie' ? '#ffffff' : color;
            if (chartData.type === 'bar' || chartData.type === 'line') {
                // small opacity for bar fill
                ds.backgroundColor = chartData.type === 'bar' ? color + 'CC' : color;
            }
        });

        new Chart(ctx, {
            type: chartData.type,
            data: chartData.data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Data Visualization' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    // Auto-dismiss Flash Messages
    setTimeout(() => {
        const flashPopup = document.getElementById('flash-popup');
        if (flashPopup) {
            flashPopup.style.opacity = '0';
            setTimeout(() => flashPopup.remove(), 500); // Remove after fade
        }
    }, 4000); // 4 seconds

    });
</script>
{% endblock %}